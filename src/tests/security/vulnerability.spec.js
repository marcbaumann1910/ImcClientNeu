import { test, expect } from '@playwright/test';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const PUBLIC_WHITELIST = ['/login', '/register', '/logout', '/reset-password', '/reset-password-request', '/mietvertragconfirm'];
const MEMBER_SEARCH_TERM = 'Marc';
const MEMBER_FULL_NAME = 'Marc Baumann';

function getRoutesFromRouterConfig() {
    const routerPath = path.resolve(__dirname, '../../../src/router/index.js');
    try {
        const content = fs.readFileSync(routerPath, 'utf8');
        const foundPaths = [];
        let match;
        const pathRegex = /path:\s*['"]([^'"]+)['"]/g;
        while ((match = pathRegex.exec(content)) !== null) {
            if (!match[1].includes(':')) foundPaths.push(match[1]);
        }
        return [...new Set(foundPaths)];
    } catch { return []; }
}

async function fillExterneNummerDialog(page) {
    const dialog = page.getByRole('dialog').filter({ hasText: 'Externe Inventar-Nummer' }).first();
    await expect(dialog).toBeVisible({ timeout: 10000 });

    const acInputs = dialog.locator('.v-autocomplete input');
    if ((await acInputs.count()) > 0) {
        await acInputs.first().click();
        await page.waitForTimeout(1500);
        const options = page.locator('.v-overlay-container .v-list-item, [role="option"]');

        if (await options.count() === 0) {
            console.log("Kein Bestand im Dialog gefunden.");
            await page.keyboard.press('Escape');
            return false;
        }
        await options.first().click({ force: true });
    } else {
        const inventarBox = dialog.getByRole('textbox', { name: /Inventar-Nummer/i }).first();
        if (await inventarBox.isVisible()) await inventarBox.fill(`TEST-${Date.now()}`);
    }
    await dialog.getByRole('button', { name: /Speichern/i }).click();
    await expect(dialog).toBeHidden();
    return true;
}

test.describe('Security Audit', () => {

    // 1. DYNAMISCHER ROUTE-CHECK (G√§ste)
    const allRoutes = getRoutesFromRouterConfig();
    for (const route of allRoutes) {
        test(`Access Audit: Route "${route}" must be protected`, async ({ page }) => {
            if (PUBLIC_WHITELIST.includes(route)) return;
            await page.context().clearCookies();
            await page.goto(route);
            await expect(page).toHaveURL(/.*login/, { timeout: 10000 });
        });
    }

    test.describe('Authenticated Security Checks', () => {

        async function performLogin(page) {
            await page.goto('/login');
            await page.evaluate(() => { localStorage.clear(); sessionStorage.clear(); });
            await page.reload();
            await page.getByPlaceholder(/Email/i).fill(process.env.E2E_USER_EMAIL || 'info@marc79.de');
            await page.getByPlaceholder(/Passwort/i).fill(process.env.E2E_USER_PASS || 'Hallo-2023!');
            await page.locator('main').getByRole('button', { name: /^Login$/i }).click();
            await page.waitForURL('**/dashboard', { timeout: 30000 });
        }

        // 2. TEST: idVerein in Access & Refresh Token
        test('JWT Audit: idVerein in Access & Refresh Token', async ({ page, context }) => {
            const loginPromise = page.waitForResponse(res =>
                res.url().includes('/login') && res.request().method() === 'POST' && res.status() === 200
            );

            await performLogin(page);

            const response = await loginPromise;
            const body = await response.json();
            const accessToken = body.accessToken || body.token;

            // Access Token Check
            const accessPayload = JSON.parse(Buffer.from(accessToken.split('.')[1], 'base64').toString());
            expect(accessPayload.idVerein, 'idVerein fehlt im Access Token').toBeDefined();

            // Refresh Token Check (httpOnly Cookie)
            const cookies = await context.cookies();
            const refreshCookie = cookies.find(c => c.name === 'refreshToken');
            expect(refreshCookie, 'refreshToken Cookie fehlt').toBeDefined();

            const refreshPayload = JSON.parse(Buffer.from(refreshCookie.value.split('.')[1], 'base64').toString());
            expect(refreshPayload.idVerein, 'idVerein fehlt im Refresh Token').toBeDefined();
            expect(refreshPayload.idVerein).toEqual(accessPayload.idVerein);

            console.log(`‚úÖ Token-Audit: idVerein (${accessPayload.idVerein}) in beiden Tokens verifiziert.`);
        });

        // 3. TEST: Mandantentrennung
        test('Mandantentrennung: No horizontal data leak', async ({ page }) => {
            await performLogin(page);
            const responsePromise = page.waitForResponse(res => res.url().includes('/mitglieder') && res.request().method() === 'GET');
            await page.goto('/leihvorgang');
            const res = await responsePromise;
            const members = await res.json();
            expect(members.some(m => String(m.id) === '999999'), 'üõë SECURITY LEAK: Fremde Daten geladen!').toBe(false);
        });

        // 4. TEST: E2E Booking mit Bestand-Recovery
        test('Booking: Process with stock recovery', async ({ page }) => {
            await performLogin(page);
            await page.goto('/leihvorgang');
            await page.locator('.search-field input').fill(MEMBER_SEARCH_TERM);
            await page.getByText(MEMBER_FULL_NAME).first().click();

            let finished = false;
            let articleIndex = 0;

            while (!finished) {
                await expect(page.locator('main').getByText('‚Ç¨').first()).toBeVisible({ timeout: 15000 });
                const selects = page.locator('.v-select');
                if (articleIndex >= await selects.count()) throw new Error("Kein Artikel mit Bestand gefunden!");

                await selects.nth(articleIndex).click();
                await page.locator('.v-overlay-container .v-list-item').filter({ hasText: /^1$/ }).first().click();
                await page.getByRole('button', { name: /√úbersicht/i }).click();

                await page.locator('text=*Externe Nr. erfassen').first().click();

                if (await fillExterneNummerDialog(page)) {
                    finished = true;
                } else {
                    console.log(`Index ${articleIndex} leer. L√∂sche und versuche n√§chsten.`);
                    await page.locator('.mdi-trash-can').first().click();
                    await page.waitForTimeout(500);
                    await page.getByRole('button', { name: /ZUR√úCK/i }).click();
                    articleIndex++;
                }
            }

            await page.getByRole('button', { name: /VORGANG BUCHEN/i }).click();
            const jaBtn = page.locator('.v-card').filter({ hasText: /Mietvertrag/i }).getByRole('button', { name: /^JA$/i });
            if (await jaBtn.count()) await jaBtn.click();

            await expect(page.locator('.v-snackbar, .v-alert')).toContainText(/erfolgreich|gebucht/i, { timeout: 20000 });
        });
    });
});